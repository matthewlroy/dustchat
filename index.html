<!doctype html>
<html>

<head>
    <title>DustChat</title>
    <link rel="stylesheet" href="/res/css/style.css">
</head>

<body>
    <div id="loading_overlay">
        <span id="loading_circle"></span>
    </div>

    <div id="content_overlay" hidden>
        <h1>DustChat</h1>

        <hr>

        <div role="region" aria-labelledby="admin_actions_region_heading">
            <h2 id="admin_actions_region_heading">Admin Actions</h2>

            <button role="button" aria-expanded="false">Create Account</button>
            <button role="button" aria-expanded="false">Logs</button>
        </div>

        <div role="region" d_region_hidden="true" aria-hidden="true" aria-labelledby="create_account_region_heading">
            <h3 id="create_account_region_heading">Create Account</h3>
            <form id="create_account_form">
                <input id="email" autocomplete="email" name="email" aria-required="true" placeholder="Email *"
                    type="email" required aria-label="Enter your email address" aria-invalid="false"
                    aria-errormessage="email_error" maxlength="255">
                <span id="email_error" class="form_error_message">Please enter a valid email
                    address.</span>

                <input id="password" autocomplete="new-password" name="password" aria-required="true" type="password"
                    placeholder="Password *" required aria-label="Enter a new password" aria-invalid="false"
                    aria-errormessage="password_error" maxlength="255" minlength="8">
                <span id="password_error" class="form_error_message">Please enter a valid password of at
                    least 8 characters.</span>

                <input type="submit" formenctype="multipart/form-data" role="button" form="create_account_form"
                    aria-label="Submit create account form" id="create_account_submit_btn" value="Create Account"
                    aria-live="polite">

                <input type="hidden" aria-hidden="true" id="server" aria-errormessage="server_error"
                    aria-invalid="false">
                <span id="server_error" class="form_error_message">Something went wrong, please try again later.</span>
            </form>
        </div>

        <div role="region" d_region_hidden="true" aria-hidden="true" aria-labelledby="logging_region_heading">
            <h3 id="logging_region_heading">Logging</h3>
            <div id="log_container">
                <div id="server_log"></div>
                <div id="db_log"></div>
            </div>
        </div>
    </div>

    <script src="/res/js/script.js"></script>
    <script>
        window.addEventListener(`DOMContentLoaded`, async (event) => {
            const start = performance.now();

            await get_server_log();
            await get_db_log();
            setInterval(get_server_log, 5000);
            setInterval(get_db_log, 5000);

            const end = performance.now();
            console.log(`[script.js] >> ${event.type} <<\n\tExecution time: ${Math.round(end - start)}ms`);
        });

        async function get_server_log() {
            await fetch("server.log")
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw "server.log is empty . . .";
                    }
                })
                .then(responseText => {
                    const server_log_dom_elm = document.getElementById(`server_log`);
                    server_log_dom_elm.innerHTML = ``;

                    let top_1000_log_entries =
                        responseText.split(`\n`).reverse().slice(0, 1001);

                    let dom_elms = "<table>";

                    let i = 0;
                    top_1000_log_entries.forEach(log_entry => {
                        if (i == 0) {
                            i++;
                            dom_elms += `
                            <tr>
                               <th>#</th>
                               <th>Timestamp</th>
                               <th>Log Level</th>
                               <th>Log Type</th>
                               <th>Originating IP Address</th>
                               <th>API Called / Response Status</th>
                               <th>REST Method / Response Body</th>
                               <th>Payload Size (in bytes)</th>
                               <th>Request Body</th>
                            </tr>
                        `;
                            return;
                        }

                        dom_elms += `<tr><td>${i++}</td>`;

                        log_entry.split("] [").forEach(split_log_entry => {
                            dom_elms += (`<td>${split_log_entry.replace("[", "").replace("]", "")}</td>`);
                        });

                        dom_elms += "</tr>";
                    });

                    dom_elms += "</table>"

                    server_log_dom_elm.innerHTML = dom_elms;
                })
                .catch(e => server_log_dom_elm.innerHTML = `Error: ${e}`);
        }

        async function get_db_log() {
            await fetch("db.log")
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else {
                        throw "db.log is empty . . .";
                    }
                })
                .then(responseText => {
                    const db_log_dom_elm = document.getElementById(`db_log`);
                    db_log_dom_elm.innerHTML = ``;

                    let top_1000_log_entries =
                        responseText.split(`\n`).reverse().slice(0, 1001);

                    let dom_elms = "<table>";

                    let i = 0;
                    top_1000_log_entries.forEach(log_entry => {
                        if (i == 0) {
                            i++;
                            dom_elms += `
                            <tr>
                               <th>#</th>
                               <th>Timestamp</th>
                               <th>Log Level</th>
                               <th>Log Type</th>
                               <th>Socket Address / Exit Code</th>
                               <th>Command Issued / Response</th>
                            </tr>
                        `;
                            return;
                        }

                        dom_elms += `<tr><td>${i++}</td>`;

                        log_entry.split("] [").forEach(split_log_entry => {
                            dom_elms += (`<td>${split_log_entry.replace("[", "").replace("]", "")}</td>`);
                        });

                        dom_elms += "</tr>";
                    });

                    dom_elms += "</table>"

                    db_log_dom_elm.innerHTML = dom_elms;
                })
                .catch(e => db_log_dom_elm.innerHTML = `Error: ${e}`);
        }
    </script>
</body>

</html>